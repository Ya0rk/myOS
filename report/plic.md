# PLIC 与 PIC 详解

## 摘要

本文详细阐述了平台级中断控制器 (PLIC) 和通用可编程中断控制器 (PIC) 的概念、功能和编程接口。重点对比了 RISC-V 架构下的标准 PLIC 与 LoongArch 架构下中断控制器的异同，并解释了“可编程”在中断控制器语境下的具体含义。

## 1. PLIC (Platform-Level Interrupt Controller)

PLIC 是 **平台级中断控制器 (Platform-Level Interrupt Controller)** 的缩写，它是专门设计用来收集和分发来自系统平台（即 SoC 上的各种外设，如串口、网卡、DMA 控制器等）的中断请求的硬件模块。

### 1.1. 不同架构下的接口是否统一？(RISC-V vs. LoongArch)

**答案是不统一，这是两种不同架构下的不同实现。**

*   **RISC-V:**
    PLIC 是 **RISC-V 平台规范的一部分**。这意味着，所有遵循该规范的 RISC-V SoC，其 PLIC 模块在**寄存器布局和功能接口上是基本兼容的**。这种标准化的设计极大地提高了软件（尤其是操作系统和驱动程序）在不同 RISC-V 硬件平台之间的可移植性。一个为标准 PLIC 编写的驱动程序，理论上可以不加修改地运行在所有包含标准 PLIC 的 RISC-V 芯片上。

*   **LoongArch (龙芯架构):**
    LoongArch 拥有**自己独立设计的中断控制器架构**。它不使用 RISC-V 的 PLIC 标准。从您之前提供的设备树信息中可以看到，龙芯平台的中断控制器被描述为 `loongson,pch-pic-1.0` (平台芯片组 PIC) 和 `loongson,cpu-interrupt-controller` (CPU 中断控制器) 等。这些是龙芯特有的实现。

**结论：**
虽然 LoongArch 的中断控制器和 RISC-V 的 PLIC 在**功能目标上是相似的**（都是管理外设中断），但它们的**硬件实现和编程接口（即寄存器地址、布局和操作方式）是完全不同**的。因此，必须为它们编写各自独立的驱动程序。

### 1.2. PLIC 支持哪些通用操作？

一个标准的 PLIC 提供了一套完整的、定义良好的操作接口，主要包括：

1.  **设置中断优先级 (Set Interrupt Priority):**
    *   **功能**: 为每一个中断源（如 `uart0`, `eth0`）分配一个优先级数值。当多个中断同时到达时，PLIC 会优先处理优先级更高的中断。
    *   **举例**: 系统可以设置磁盘 I/O 完成中断的优先级高于键盘输入中断，以保证数据吞吐的效率。

2.  **使能/屏蔽中断 (Enable/Mask Interrupt):**
    *   **功能**: 为每一个 CPU核心（在 RISC-V 中称为 Hart）独立地设置它关心哪些中断源。每个 Hart 都有一组使能寄存器，其中的每一位对应一个中断源。
    *   **举例**: 在一个双核系统中，可以将所有网络相关的中断都使能给 `Core 0`，而将所有存储相关的中断使能给 `Core 1`，以实现任务的分离。

3.  **设置优先级阈值 (Set Priority Threshold):**
    *   **功能**: 为每一个 CPU 核心设置一个优先级阈值。该核心将会忽略所有优先级**低于或等于**此阈值的中断请求。
    *   **举例**: 当一个核心正在执行一个非常关键的实时任务时，可以临时将其优先级阈值调高，以屏蔽掉所有非紧急的中断，防止关键任务被干扰。

4.  **申领中断 (Claim an Interrupt):**
    *   **功能**: 当 CPU 核心被中断后，它会访问 PLIC 的一个特殊“申领寄存器”。读取该寄存器会返回当前待处理的、优先级最高的中断源 ID。这个操作是**原子**的，一旦一个核心申领了某个中断，其他核心就无法再次申领同一个中断。
    *   **举例**: CPU 收到中断信号，执行 `read(PLIC_CLAIM_REGISTER)`，如果返回值是 `10`，就代表是 ID 为 10 的设备（比如串口）触发了中断。

5.  **完成中断 (Complete an Interrupt):**
    *   **功能**: 当 CPU 核心的驱动程序处理完中断后，它需要通知 PLIC。这是通过向同一个“申领寄存器”**写入**刚刚处理完的中断源 ID 来实现的。
    *   **举例**: 串口驱动的中断服务程序执行完毕后，会执行 `write(PLIC_CLAIM_REGISTER, 10)`，通知 PLIC：“ID 为 10 的中断我已经处理完了，你可以处理下一个了。”

## 2. 可编程中断控制器 (PIC)

PIC 是 **可编程中断控制器 (Programmable Interrupt Controller)** 的通用术语。它不是特指某一个具体标准，而是一类设备的总称。**PLIC、ARM 的 GIC、x86 的 APIC 等，都属于 PIC 的范畴。**

它的核心价值在于，通过软件编程的方式，灵活地管理和控制中断行为，而不是像早期计算机那样使用固化的硬件逻辑。

### 2.1. “可编程”是指支持哪些操作？

“可编程”主要体现在以下几个方面，这些操作赋予了软件对中断处理流程的完全控制权：

1.  **中断屏蔽 (Masking):**
    *   **含义**: 可以通过编程，动态地“打开”或“关闭”某个具体的中断线。
    *   **举例**: 在更新一个与网卡共享的内核数据结构时，操作系统可以暂时屏蔽掉来自该网卡的中断，以防止在更新过程中被中断服务程序干扰，从而避免数据竞争。操作完成后再重新使能该中断。

2.  **中断优先级 (Priority):**
    *   **含义**: 可以通过编程，为不同的中断源设置不同的优先级。
    *   **举例**: 一个连接到 UPS（不间断电源）的告警中断，其优先级应该被设置为最高的。当市电断电时，这个中断可以抢占几乎所有其他任务（如视频播放、文件拷贝），强制系统执行保存数据和安全关机的流程。

3.  **中断路由 (Routing / Affinity):**
    *   **含义**: 在多核系统中，可以编程决定将某个外设的中断请求发送给哪一个（或哪些）CPU 核心处理。
    *   **举例**: 为了提升网络性能，可以将 `eth0` 网卡的所有中断都路由到 `CPU 2`。这样，与网络数据包处理相关的缓存（如协议栈的 socket 缓冲区）更有可能一直保留在 `CPU 2` 的 L1/L2 缓存中，减少了跨核缓存同步的开销，提升了处理效率。

4.  **触发模式 (Triggering Mode):**
    *   **含义**: 可以编程设置中断信号的触发方式，通常是**边沿触发 (Edge-triggered)** 或 **电平触发 (Level-triggered)**。
    *   **边沿触发举例**: 键盘按键。当中断线上的电平从高变低（或从低变高）的**瞬间**，产生一次中断。即使你一直按着键，也只触发一次。
    *   **电平触发举例**: 设备过热警告。只要设备温度高于阈值，中断线就一直保持高电平，并**持续地**向 CPU 请求中断，直到驱动程序采取措施让设备降温，信号线恢复低电平为止。这种方式更可靠，不容易丢失中断。
